# Boojy Audio v0.2 â€” Design Specification

**Theme:** Recording & Mixing Essentials
**Focus:** Everything needed to record, mix, and draft a beat/instrumental/song quickly.

---

## Features (9 total)

### 1. Send/Return Effects

**What:** Shared effect buses. Create a "Reverb Bus" return track, then send audio from any track to it via a knob. Saves CPU, sounds cohesive.

**UX â€” Beginner flow (presets):**
1. Click `[+ Bus]` at bottom of mixer panel
2. Pick preset: "Reverb Bus", "Delay Bus", or "Empty Return"
3. Return track appears in mixer with the effect pre-loaded
4. Send knobs auto-appear on every regular track strip
5. Turn a send knob to route that track's audio to the return

**UX â€” Advanced flow (manual):**
1. Create a Return track from add-track menu
2. Add any VST3 effects to its chain
3. Right-click any track â†’ "Add Send" â†’ pick the return
4. Right-click a send knob â†’ toggle pre/post fader

**Mixer layout â€” return tracks appear between regular tracks and master:**
```
Regular tracks              â•‘ Return tracks          â”‚ Master
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Drums    â”‚ Bass     â”‚     â•‘ â”‚ Reverb   â”‚ Delay    â”‚â”‚â”‚ MASTER   â”‚
â”‚ midi     â”‚ midi     â”‚     â•‘ â”‚ return   â”‚ return   â”‚â”‚â”‚          â”‚
â”‚ Rvb [â—25]â”‚ Rvb [â—10]â”‚     â•‘ â”‚ [FX:Rvb] â”‚ [FX:Dly] â”‚â”‚â”‚          â”‚
â”‚  [M][S]  â”‚  [M][S]  â”‚     â•‘ â”‚  [M][S]  â”‚  [M][S]  â”‚â”‚â”‚          â”‚
â”‚  â•â•â•â•    â”‚  â•â•â•â•    â”‚     â•‘ â”‚  â•â•â•â•    â”‚  â•â•â•â•    â”‚â”‚â”‚  â•â•â•â•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†‘                        â†‘
                   Thin divider              Thin divider
            (no return section visible until user creates one)
```

**Mixer strip with sends:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸµ Audio 1        [M][S][R]     [Pan â”€â”€â—â”€â”€]              â”‚
â”‚  [Auto] [-12.3 dB]  [â•â•â•â•â•â•â•â•â—â•â•â•â•â•â•â•â• fader]              â”‚
â”‚  Sends: [Rvb â—25%] [Dly â—10%]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”Š Reverb Bus     [M][S]       [Pan â”€â”€â—â”€â”€]    RETURN     â”‚
â”‚  [FX: Reverb]      [â•â•â•â•â•â•â•â•â—â•â•â•â•â•â•â•â• fader]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Quick-add dialog:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Add Effect Bus         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”Š Reverb Bus         â”‚
â”‚  ğŸ”Š Delay Bus          â”‚
â”‚  ğŸ”Š Chorus Bus         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  âš™  Empty Return       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Scope:**
- **Rust:** Wire send routing in `audio_graph.rs` render loop (copy track audio to return, scaled by send amount). Process return tracks after regular tracks, sum to master. New API: `add_send_to_track`, `remove_send`, `set_send_amount`, `set_send_pre_fader`, `create_return_track_with_effect`
- **FFI:** Expose all new send/return APIs
- **Flutter:** Send knobs on mixer strips, return track type in mixer, quick-add dialog, right-click context menus
- **Files:** `engine/src/audio_graph.rs`, `engine/src/ffi.rs`, `ui/lib/widgets/track_mixer_panel.dart`, new `send_knob.dart`

---

### 2. Better Sampler Editor UI

**What:** The sampler editor should be a **superset of the Audio Editor** â€” it gets ALL the same non-destructive audio controls, PLUS sampler-specific controls. Replace placeholder waveform with real data.

**Current state:** Loads one sample, pitch-shifts via root note, basic AR envelope. Waveform is fake placeholder data. Missing most controls that Audio Editor has.

**The sampler must include ALL Audio Editor features:**
- Gain (-inf to +12 dB)
- Transpose (-48 to +48 semitones)
- Fine pitch (-100 to +100 cents)
- Time stretch (0.5x to 2.0x)
- Warp mode (Warp vs Re-Pitch)
- Reverse
- Normalize target
- Loop enable + loop region
- Time sync (sync to project tempo)
- Offset/trim

**PLUS sampler-specific controls:**
- Root note selector
- Attack / Release envelope
- One-shot toggle (plays full sample, ignores note-off)
- Sampler loop start/end markers on waveform

**Improved editor layout:**
```
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚ SAMPLER EDITOR                                            [x]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€ Sampler Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Root [C4 â–¼]  Attack [â•â•â—â”€â”€] 10ms  Release [â•â•â•â—â”€] 100ms   â”‚  â”‚
â”‚ â”‚              [One-Shot: OFF]   [Loop: ON]                   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ â”Œâ”€ Audio Controls (same as Audio Editor) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ Gain [â•â•â—â”€â”€] 0dB   Transpose [â—] 0st   Fine [â—] 0ct       â”‚  â”‚
â”‚ â”‚ Stretch [â•â•â—â”€â”€] 1.0x   [Warp â–¼]   [Reverse]   [Normalize] â”‚  â”‚
â”‚ â”‚ Time Sync [OFF]   Offset [â•â•â—â”€â”€]                            â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ruler: |1    |2    |3    |4    |              [- +] zoom         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       LS                    LE                                    â”‚
â”‚       â”‚  ___/\___          â”‚                                     â”‚
â”‚       â”‚/         \         â”‚  â† real waveform from engine        â”‚
â”‚       â”‚           \________â”‚                                     â”‚
â”‚       [===loop region===]                                        â”‚
â”‚  Attackâ–¸â”‚              â”‚â—‚Release                                 â”‚
â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
  LS/LE = draggable loop start/end markers
  One-Shot = plays full sample ignoring note-off
  All audio controls (gain, transpose, stretch, etc.) work identically to Audio Editor
```

**Scope:**
- **Rust:** Add `loop_start_frame`, `loop_end_frame`, `loop_enabled`, `one_shot` to Sampler. Add audio editing params (gain, transpose, fine_pitch, time_stretch, warp_mode, reverse, normalize, time_sync, offset). New API: `get_sampler_waveform(track_id, resolution)` returning real peaks
- **FFI:** `get_sampler_waveform_ffi`, loop/one-shot parameter setters, all audio edit parameter setters
- **Flutter:** Replace `_loadSampleData()` placeholder with engine call. Add loop marker overlay, one-shot toggle, loop toggle. Add all Audio Editor controls (extract shared widget from Audio Editor for reuse). Reorganize into two control sections (Sampler + Audio)
- **Files:** `engine/src/sampler.rs`, `ui/lib/widgets/sampler_editor/sampler_editor.dart`, `sampler_controls_bar.dart`, extract shared `audio_edit_controls.dart` from Audio Editor

---

### 3. MIDI CC Recording (Sustain Pedal + Pitch Bend)

**What:** Record sustain pedal (CC64) and pitch bend from MIDI controllers. Currently only note-on/off captured â€” CC messages are explicitly ignored in `midi_input.rs`.

**Piano roll with recorded CC data:**
```
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚ Piano Roll                                    [Tools] [Close] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ C5     â”‚  â•â•â•â•          â•â•â•â•                                  â”‚
â”‚ B4     â”‚                                                      â”‚
â”‚ A4     â”‚        â•â•â•â•                                          â”‚
â”‚ G4     â”‚                     â•â•â•â•                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CC Laneâ”‚ [Sustain â–¼]                    Height: [â•â•â—â•]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  127   â”‚  ________        ________                            â”‚
â”‚        â”‚ â”‚        â”‚      â”‚        â”‚   â† sustain on/off        â”‚
â”‚    0   â”‚_â”‚        â”‚______â”‚        â”‚_________________________  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CC Laneâ”‚ [Pitch Bend â–¼]                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ +8191  â”‚         /\                                           â”‚
â”‚    0   â”‚â”€â”€â”€â”€â”€â”€â”€â”€/  \â”€â”€â”€â”€â”€â”€â”€â”€/\â”€â”€â”€â”€â”€â”€â”€â”€ center line            â”‚
â”‚ -8192  â”‚                   /  \_______                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Scope:**
- **Rust:** Add `ControlChange { controller, value }` and `PitchBend { value }` to `MidiEventType`. In `midi_input.rs`, handle 0xB0 (CC) and 0xE0 (pitch bend) instead of ignoring. In `synth.rs`, add `process_cc()` for sustain hold and `process_pitch_bend()`. In playback, forward CC events to instruments
- **FFI:** `get_midi_clip_cc_events_ffi`, `add_midi_cc_to_clip_ffi`
- **Flutter:** Wire `MidiCCLane` and `MidiCCPoint` models (already exist) to real engine data. Display recorded CC in piano roll CC lanes
- **Files:** `engine/src/midi.rs`, `engine/src/midi_input.rs`, `engine/src/synth.rs`, `ui/lib/widgets/piano_roll/piano_roll_cc_lane.dart`

---

### 4. Input Monitoring

**What:** Hear live audio input through the DAW while playing/recording. Essential for recording with confidence.

**Mixer strip with monitor toggle:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸµ Audio 1        [M][S][R][ğŸ§]     [Pan â”€â”€â—â”€â”€]          â”‚
â”‚                                 â†‘                           â”‚
â”‚                          Monitor toggle                     â”‚
â”‚                     (headphone icon, glows when active)     â”‚
â”‚  [Auto] [-12.3 dB]  [â•â•â•â•â•â•â•â•â—â•â•â•â•â•â•â•â• fader]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Only shown on Audio tracks (MIDI monitoring is already implicit â€” always-on)
- When ON + armed: live input routes through track FX chain to output
- When OFF: input only captured during recording, not audible

**Scope:**
- **Rust:** In `audio_graph.rs` render loop, when `input_monitoring && armed`, mix input buffer into track chain. New API: `set_track_input_monitoring(track_id, enabled)`
- **FFI:** `set_track_input_monitoring_ffi`
- **Flutter:** Headphone toggle on audio track mixer strips
- **Files:** `engine/src/audio_graph.rs`, `ui/lib/widgets/track_mixer_strip.dart`

---

### 5. Tempo Automation

**What:** Tempo changes over time on a master tempo track. Currently fixed BPM per project.

**Tempo lane at top of arrangement:**
```
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚ Tempo Track   [Hold/Ramp: Ramp â–¼]                   [-][+]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 200    â”‚                                                      â”‚
â”‚        â”‚              â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—                           â”‚
â”‚ 120    â”‚ â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—             \                          â”‚
â”‚        â”‚                            â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—             â”‚
â”‚  60    â”‚                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        â”‚ 1       5       9       13      17      21   bars    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Transport bar shows live tempo at playhead:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [<<] [â–¶] [â—]  1:23.4  â”‚ 140.0 BPM â”‚  4/4                  â”‚
â”‚                          â†‘ updates in real-time              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Scope:**
- **Rust:** New `TempoMap` with `Vec<TempoPoint>` (beat, bpm, interpolation). Replace static `tempo` with map lookups. `beat_to_seconds()` / `seconds_to_beat()` via piecewise integration. Backward compat: empty map = static tempo
- **FFI:** `add_tempo_point_ffi`, `remove_tempo_point_ffi`, `get_tempo_map_ffi`, `get_tempo_at_beat_ffi`
- **Flutter:** New `tempo_lane.dart` widget (reuse automation lane pattern). Update transport bar to show live tempo
- **Files:** `engine/src/audio_graph.rs` (or new `tempo.rs`), `ui/lib/widgets/tempo_lane.dart`, `ui/lib/widgets/transport_bar/`
- **Note:** Most architecturally impactful feature â€” changes core timing. Implement last.

---

### 6. Punch In/Out Recording

**What:** Record only within a defined region. Set loop markers as punch region, recording auto-starts/stops at boundaries.

**Transport bar with punch mode:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [<<] [â–¶] [â—] [P]  1:23.4  â”‚ 120 BPM â”‚  4/4               â”‚
â”‚              â†‘                                              â”‚
â”‚         Punch toggle                                        â”‚
â”‚    Grey = off, Red background = on                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Timeline with punch region:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ |1    |2    |3    |4    |5    |6    |7    |8    |          â”‚
â”‚        [â–Œâ•â•PUNCH REGIONâ•â•â–]                                â”‚
â”‚        (red brackets at loop markers when punch is on)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Audio 1 â”‚   existing clip                                  â”‚
â”‚         â”‚   [==RECORDING==]     â”‚                          â”‚
â”‚              â†‘punch in    â†‘punch out                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Scope:**
- **Rust:** Add `punch_enabled`, `punch_in_beats`, `punch_out_beats` to transport. Gate recording start/stop based on playhead position vs punch boundaries. Reuse loop markers as punch region
- **FFI:** `set_punch_mode_ffi(enabled, in_beats, out_beats)`
- **Flutter:** Punch toggle on transport bar. Red bracket indicators on timeline when punch active
- **Files:** `engine/src/recorder.rs`, `engine/src/midi_recorder.rs`, `ui/lib/widgets/transport_bar/`

---

### 7. Freeze/Bounce Track (Non-Destructive)

**What:** Render a track with all effects to audio, freeing CPU. Unlike Ableton, this is non-destructive â€” original data preserved, can unfreeze.

**Frozen track appearance:**
```
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚  â„ Synth Lead (Frozen)    [M][S][R]     [Pan â”€â”€â—â”€â”€]         â”‚
â”‚  [FX greyed] [-3.2 dB]  [â•â•â•â•â•â•â•â•â—â•â•â•â•â•â•â•â• fader]            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [â•â•â•â•â•â•â•â•â•â•â•FROZEN WAVEFORMâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•]       â”‚
â”‚  FX chain bypassed â€” volume/pan still adjustable              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Context menu:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rename            â”‚
â”‚ Change Color      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ â„ Freeze Track   â”‚  â† when not frozen
â”‚ ğŸ”¥ Unfreeze      â”‚  â† when frozen (restores original)
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚ Delete            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Freeze progress:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Freezing "Synth Lead"...        â”‚
â”‚  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘] 72%      â”‚
â”‚  [Cancel]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Scope:**
- **Rust:** Reuse offline render from export module. New API: `freeze_track(track_id)` renders to WAV, marks frozen. `unfreeze_track(track_id)` restores. Add `frozen`, `frozen_audio_path` to Track
- **FFI:** `freeze_track_ffi`, `unfreeze_track_ffi`, `is_track_frozen_ffi`
- **Flutter:** Snowflake icon on frozen tracks, greyed FX, context menu options, progress dialog
- **Files:** `engine/src/track.rs`, `engine/src/audio_graph.rs`, `ui/lib/widgets/track_mixer_strip.dart`

---

### 8. Scale/Key Snapping in Piano Roll

**What:** Constrain note editing to a musical scale. Highlight in-scale notes, lock drawing to scale, fold out-of-scale rows.

**Already exists:** `Scale` class with `containsNote()`, `snapToScale()`, `getNotesInRange()`. `ScaleType` enum with 11 scales. UI controls for root/type with Hi/Lock/Fold toggles. **Not wired to note operations.**

**Piano roll with C Major highlighting:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Scale  â”‚                                                      â”‚
â”‚[C  â–¼]  â”‚ C5  [bright] â•â•â•â•                                   â”‚
â”‚[Maj â–¼] â”‚ B4  [bright]                                        â”‚
â”‚        â”‚ A#4 [dim]        â† not in C Major                   â”‚
â”‚[Hi ON] â”‚ A4  [bright]       â•â•â•â•                              â”‚
â”‚[Lk ON] â”‚ G#4 [dim]                                           â”‚
â”‚[Fd OFF]â”‚ G4  [bright]                                        â”‚
â”‚        â”‚ F#4 [dim]                                            â”‚
â”‚        â”‚ F4  [bright]                                         â”‚
â”‚        â”‚ E4  [bright]                                         â”‚
â”‚        â”‚ D#4 [dim]                                            â”‚
â”‚        â”‚ D4  [bright]                                         â”‚
â”‚        â”‚ C#4 [dim]                                            â”‚
â”‚        â”‚ C4  [ROOT â€” brightest]  â•â•â•â•                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Fold mode (only scale notes visible):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚[Fd ON] â”‚ C5  â•â•â•â•                 â”‚
â”‚        â”‚ B4                       â”‚
â”‚        â”‚ A4        â•â•â•â•           â”‚
â”‚        â”‚ G4                       â”‚  â† 7 notes per octave
â”‚        â”‚ F4                       â”‚     instead of 12
â”‚        â”‚ E4                       â”‚
â”‚        â”‚ D4                       â”‚
â”‚        â”‚ C4  â•â•â•â•                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Scope:**
- **Rust:** None â€” purely UI/editing
- **Flutter:** Wire `scale.snapToScale()` to draw/move operations when Lock enabled. Wire `scale.containsNote()` to grid painter for row brightness. Implement Fold mode filtering
- **Files:** `ui/lib/widgets/piano_roll/piano_roll_state.dart`, `ui/lib/widgets/painters/grid_painter.dart`, `ui/lib/widgets/piano_roll/operations/`

---

### 9. MIDI Learn

**What:** Map hardware MIDI controller knobs/sliders to DAW parameters. Right-click â†’ MIDI Learn â†’ move knob â†’ mapped.

**Workflow:**
```
Step 1: Right-click parameter       Step 2: Learning overlay
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rename            â”‚               â”‚  MIDI Learn Active        â”‚
â”‚ MIDI Learn   â†â”€â”€â”€â”€â”‚               â”‚                           â”‚
â”‚ Edit MIDI Maps    â”‚               â”‚  Move a control on your   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  MIDI device...           â”‚
                                    â”‚  [Cancel]                 â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: Confirmed                   Mappings dialog:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚  Mapped!                  â”‚       â”‚ MIDI Mappings                [x]  â”‚
â”‚  CC 1 (Ch 1) â†’ Volume    â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Audio 1                  â”‚       â”‚ CC    â”‚ Ch  â”‚ Target             â”‚
â”‚  (auto-dismiss 2s)        â”‚       â”‚ CC 1  â”‚ 1   â”‚ Audio 1 > Volume   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ CC 2  â”‚ 1   â”‚ Audio 1 > Pan      â”‚
                                    â”‚ CC 64 â”‚ 1   â”‚ Master > Volume    â”‚
                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                    â”‚ [Clear All]                      â”‚
                                    â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
```

**Scope:**
- **Rust:** New `midi_learn.rs` module with `MidiMapping` and `MidiLearnManager`. Extend `midi_input.rs` to route CC to learn manager. APIs: `start_midi_learn`, `stop_midi_learn`, `get_midi_mappings`, `remove_midi_mapping`
- **FFI:** All learn/mapping APIs
- **Flutter:** "MIDI Learn" in context menus of all controllable parameters. Learning overlay widget. Mappings dialog. Small indicator on mapped parameters
- **Files:** New `engine/src/midi_learn.rs`, `ui/lib/widgets/midi_learn_overlay.dart`, `ui/lib/widgets/dialogs/midi_mappings_dialog.dart`
- **Depends on:** Feature 3 (CC parsing in engine)

---

## Implementation Order

Based on dependencies and complexity:

**Phase 1 â€” Quick wins (existing scaffolding):**
1. **Input Monitoring** â€” Smallest scope, engine field exists, immediate value
2. **Scale/Key Snapping** â€” All models + UI exist, just wiring, no engine changes
3. **Better Sampler Editor** â€” Self-contained, existing sampler works

**Phase 2 â€” Core features:**
4. **MIDI CC Recording** â€” Engine MIDI parser changes, foundational for MIDI Learn
5. **Send/Return Effects** â€” Engine routing + UI, significant scope
6. **Punch In/Out Recording** â€” Recording pipeline modification

**Phase 3 â€” Advanced:**
7. **Freeze/Bounce Track** â€” Leverages export infrastructure, careful state management
8. **MIDI Learn** â€” Needs CC infrastructure from step 4, broad UI surface
9. **Tempo Automation** â€” Most impactful architecturally, changes core timing, do last

---

## v0.3 Parking Lot

| Feature | Notes |
|---------|-------|
| Fade In/Out | Fade curves on clip edges (linear, exponential, S-curve) |
| Crossfades | Auto-crossfade when clips overlap on same track |
| Track Grouping/Folders | `TrackType::Group` already scaffolded in engine |
| Plugin Presets | Save/load presets per effect/instrument |
| Arrangement Markers | Named markers on timeline ruler (Intro, Verse, etc.) |
